<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        #cas{
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 1px solid;
        }
    </style>
</head>
<body>
<canvas id="cas" width="1000" height="500"></canvas>

<script>
    var canvas = document.getElementById("cas");
    var ctx = canvas.getContext("2d");

    var dr = 4;
    var dots = [];
    var img = new Image();
    img.src = "./test2.jpg";
    img.onload = function(){
        var img_w = img.width/2;
        var img_h = img.height/2;
        var left = (canvas.width - img_w)/2;
        var top = (canvas.height - img_h)/2;
        dots = [
            { x:left, y:top },
            { x:left + img_w, y:top },
            { x:left + img_w, y:top + img_h},
            { x:left, y:top + img_h}
        ];

        render()
    }


//    var dots = [
//        { x:100, y:100 },
//        { x:400, y:100 },
//        { x:400, y:400 },
//        { x:100, y:400 }
//    ];

//    render();
    window.onmousedown = function(e){
        if(!dots.length)return;

        var area = getArea(e);
        var dot,i;

        for (i = 0; i < dots.length; i++) {
            dot = dots[i];
            if (area.t >= (dot.y - dr) && area.t <= (dot.y + dr) && area.l >= (dot.x - dr) && area.l <= (dot.x + dr)) {
                break;
            } else {
                dot = null;
            }
        }

        if(!dot) return;

        window.onmousemove = function(e){
            var narea = getArea(e);
            var nx = narea.l-area.l;
            var ny = narea.t-area.t;

            dot.x += nx;
            dot.y += ny;

            area = narea;

            render();
        };

        window.onmouseup = function(){
            window.onmousemove = null;
            window.onmouseup = null;
        }
    };

    function getArea(e){
        e = e || window.event;
        return {
            t : e.clientY - canvas.offsetTop + document.body.scrollTop + document.documentElement.scrollTop,
            l : e.clientX - canvas.offsetLeft + document.body.scrollLeft + document.documentElement.scrollLeft
        }
    }

    function render(){
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(dots[0].x , dots[0].y);
        ctx.lineTo(dots[1].x , dots[1].y);
        ctx.lineTo(dots[2].x , dots[2].y);
        ctx.lineTo(dots[3].x , dots[3].y);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = "#fff";
        dots.forEach(function(d , i){
            ctx.fillRect(d.x - dr, d.y - dr, dr * 2, dr * 2);
            ctx.strokeRect(d.x - dr, d.y - dr, dr * 2, dr * 2);
        });
        ctx.restore();

        renderImage(dots[0] , dots[1] , dots[3]);

        renderImage(dots[2] , dots[1] , dots[3] , true);

    }

//    传入的点为/-/
    function renderImage(dot1 , dot2 , dot3 , isf){
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(dot1.x, dot1.y);
        ctx.lineTo(dot2.x, dot2.y);
        ctx.lineTo(dot3.x, dot3.y);
        ctx.closePath();
        ctx.clip();

        //点1指向点2的 向量1
        var xl1 = [dot2.x-dot1.x , dot2.y - dot1.y];

        //点1指向点3的 向量2
        var xl2 = [dot3.x-dot1.x , dot3.y - dot1.y];

        //向量1和向量2的向量和
        var xl3 = [xl1[0] + xl2[0] , xl1[1] + xl2[1]];

        //算出平行四边形的第四个端点坐标
        var edot = { x:xl3[0] + dot1.x, y:xl3[1] + dot1.y };

        //平行四边形中点坐标
        var mdot = { x:(edot.x + dot1.x)/2, y:(edot.y + dot1.y)/2 };

        //基本点坐标，是以哪个点为基准绘制图片
        var base = isf ? edot : dot1;

        //基于x轴的斜切 和 基于y轴的斜切
        var xq = (dot2.y - base.y) / (dot2.x - base.x);
        var yq = (dot3.x - base.x) / (dot3.y - base.y);

        var img_w = Math.abs(dot2.x - base.x);
        var img_h = Math.abs(dot3.y - base.y);

        ctx.setTransform(1, xq, yq, 1, mdot.x , mdot.y);
        ctx.drawImage(img , -img_w/2 , -img_h/2 , img_w , img_h);

        ctx.lineWidth = 5;
        ctx.strokeStyle = "red";
        ctx.stroke();

        ctx.restore();
    }

//    解三元一次方程
    function equation(arr1 , arr2 , arr3){
        var a1 = +arr1[0];
        var b1 = +arr1[1];
        var c1 = +arr1[2];
        var d1 = +arr1[3];

        var a2 = +arr2[0];
        var b2 = +arr2[1];
        var c2 = +arr2[2];
        var d2 = +arr2[3];

        var a3 = +arr3[0];
        var b3 = +arr3[1];
        var c3 = +arr3[2];
        var d3 = +arr3[3];

        var m1 = c1 - (b1 * c2 / b2);
        var m2 = c2 - (b2 * c3 / b3);
        var m3 = d2 - (b2 * d3 / b3);
        var m4 = a2 - (b2 * a3 / b3);
        var m5 = d1 - (b1 * d2 / b2);
        var m6 = a1 - (b1 * a2 / b2);

        var x = ((m1 / m2) * m3 - m5)/((m1 / m2) * m4 - m6) || 0;
        var z = (m5 - m6 * x) / m1 || 0;
        var y = (d1 - a1 * x - c1 * z) / b1 || 0;

        return {
            x : x,
            y : y,
            z : z
        }
    }
</script>
</body>
</html>