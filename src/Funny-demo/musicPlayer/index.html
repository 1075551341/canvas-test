<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>音乐播放器</title>
	<style type="text/css">
		body{color: #FFF;}
		#cas{
			position: absolute;
			left:0;top:0;bottom: 0;right: 0;
			margin: auto;
			background:#000;
		}
		#mp3{visibility: hidden;}
	</style>
</head>
<body style="background:#000">

	<canvas id="cas" width="990" height="540"></canvas>

	<audio src="music.mp3" preload autoplay loop='loop' id="mp3"></audio>

	<input type="file" id="musicFile"/>  也可以自行选择自己的音乐

	<script type="text/javascript" charset="utf-8">
		var canvas = document.getElementById("cas"),
			ctx = canvas.getContext("2d");

		//绘制音谱的参数
		var tgs = [],
			tgn = 35,
			jg = 4,
			ot = 0,
			outcanvas = null;

		var paintStop = false;

		var grd = ctx.createLinearGradient(0, 110, 0, 270);
		grd.addColorStop(0, "red");
		grd.addColorStop(0.3, "yellow");
		grd.addColorStop(1, "#00E800");

		// analyser为analysernode，具有频率的数据，用于创建数据可视化
		// source 为音频源，可能为audio源也可能为buffer源
		var analyser, source;

		//实例化音频对象
		var AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
		var AC = new AudioContext();

		//计时器
		var RAF = (function() {
			return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
				window.setTimeout(callback, 1000 / 60);
			};
		})();

		//播放音乐
		var audio = document.getElementById("mp3");
		audio.onended = function(){
			audio.play();
		}
		playMusic(audio);

		//在下一次事件循环中执行动画
		setTimeout(function(){
			initAnimation();
		}, 0);

		//如果用户选取了自己的音乐则通过filereader读取
		document.getElementById('musicFile').onchange = function() {
			if (!audio.ended || !audio.paused) audio.pause();
			if ('stop' in source) source.stop();

			paintStop = true;

			ctx.clearRect(0,0,canvas.width,canvas.height)
			ctx.save();
			ctx.fillStyle = "#FFF";
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";
			ctx.font = "20px 微软雅黑";
			ctx.fillText("音频加载中..." , canvas.width/2 , canvas.height/2);
			ctx.restore();

			var fr = new FileReader();
			fr.readAsArrayBuffer(this.files[0]);
			fr.onload = function(e) {
				decodeBuffer(e.target.result , function(buffer){
					paintStop = false;
					playMusic(buffer);
				})
			};
		};

		//对音频buffer进行解码
		function decodeBuffer(arraybuffer , callback) {
			AC.decodeAudioData(arraybuffer, function(buffer) {
				callback(buffer);
			}, function(e) {
				alert("文件解码失败")
			})
		}

		//音频播放
		function playMusic(arg) {
			//如果arg是audio的dom对象，则转为相应的源
			if(arg.nodeType){
				source = AC.createMediaElementSource(arg);
			}else {
				source = AC.createBufferSource();

				source.buffer = arg;

				//播放音频
				setTimeout(function(){source.start()}, 0);
			}

			analyser = analyser || AC.createAnalyser();

			//连接analyserNode
			source.connect(analyser);

			//连接音频的最终输出节点
			source.connect(AC.destination);
		}

		//动画初始化，获取analyserNode里的音频数据
		function initAnimation() {
			outcanvas = document.createElement("canvas");
			outcanvas.width = canvas.width;
			outcanvas.height = canvas.height / 2;
			var array = new Uint8Array(analyser.frequencyBinCount);
			analyser.getByteFrequencyData(array);
			var w = array.length / tgn - jg;
			for (var i = 0; i < tgn; i++) {
				tgs.push(new retangle(w, 5, (i * (array.length / tgn)), canvas.height / 2))
			}
			ot = new Date();
			animate();
		}

		function animate() {
			if(!paintStop){
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				var array = new Uint8Array(analyser.frequencyBinCount);
				analyser.getByteFrequencyData(array);
				var nt = new Date();
				for (var i = 0; i < tgs.length; i++) {
					tgs[i].update(array[~~(i * array.length / tgn)], (nt - ot) / 1000)
				}
				copy();
				ot = nt;
			}
			
			RAF(animate)
		}

		function copy() {
			var outctx = outcanvas.getContext("2d");
			var imgdata = ctx.getImageData(0, 0, canvas.width, canvas.height / 2);
			for (var i = 0; i < imgdata.data.length; i += 4) {
				imgdata.data[i + 3] = 50;
			}
			outctx.putImageData(imgdata, 0, 0);
			ctx.save();
			ctx.translate(canvas.width / 2, canvas.height / 2);
			ctx.rotate(Math.PI);
			ctx.scale(-1, 1);
			ctx.drawImage(outcanvas, -canvas.width / 2, -canvas.height / 2)
			ctx.restore();
		}

		var retangle = function(w, h, x, y) {
			this.w = w;
			this.h = h;
			this.x = x;
			this.y = y;
			this.jg = 3;
			this.power = 0;
			this.dy = y;
			this.dv = 100;
			this.num = 0;
			this.a = Math.random() * 50 + 100
			this.b = Math.random() * 50 + 120
		}

		retangle.prototype = {
			update: function(power, times) {
				this.power = power;
				this.num = ~~(this.power / this.h + 0.5);
				if (this.power > this.y - (this.dy + this.h)) {
					this.dy = this.y - this.power - this.h - 1;
				} else if (this.dy + this.h > this.y) {
					this.dy = this.y - this.h
				} else {
					this.dy += this.dv * times
				}

				this.draw();
			},
			draw: function() {
				ctx.fillStyle = grd;
				var h = (~~(this.power / (this.h + this.jg))) * (this.h + this.jg);
				ctx.fillRect(this.x, this.y - h, this.w, h)
				for (var i = 0; i < this.num; i++) {
					var y = this.y - i * (this.h + this.jg);
					ctx.clearRect(this.x - 1, y, this.w + 2, this.jg);
				}
				ctx.fillStyle = "#950000"
				ctx.fillRect(this.x, this.dy, this.w, this.h);
			}
		}
	</script>
</body>
</html>